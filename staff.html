<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>工作人員後台 (v3 - 整合管理)</title>
    <style>
        :root { --bg-color: #121212; --surface-color: #1e1e1e; --primary-color: #f0c419; --text-color: #e0e0e0; --text-secondary-color: #a0a0a0; --font-main: 'Noto Sans TC', sans-serif; --border-radius: 12px; --border-color: rgba(255, 255, 255, 0.1); }
        body { font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 1.5rem; }
        .admin-dashboard { max-width: 1400px; margin: auto; }
        .tabs { display: flex; gap: 0.5rem; border-bottom: 1px solid var(--border-color); margin-bottom: 2rem; }
        .tab-btn { padding: 1rem 1.5rem; background: none; border: none; color: var(--text-secondary-color); font-size: 1.1rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* ----- 舊的客服面板樣式 (稍作調整) ----- */
        .admin-panel { display: flex; height: 75vh; gap: 1.5rem; }
        .sidebar { width: 300px; flex-shrink: 0; background-color: var(--surface-color); border-radius: var(--border-radius); display: flex; flex-direction: column; }
        .chat-view { flex-grow: 1; background-color: var(--surface-color); border-radius: var(--border-radius); display: flex; flex-direction: column; padding: 1.5rem; }
        .sidebar-header, .chat-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h2, .chat-header h2 { margin: 0; font-size: 1.5rem; }
        #user-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .user-item { padding: 1rem 1.5rem; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .user-item.active, .user-item:hover { background-color: rgba(240, 196, 25, 0.1); }
        #chat-window { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        /* ----- 月曆管理頁面樣式 (與顧客端類似但有區別) ----- */
        .calendar-management-panel { display: flex; gap: 1.5rem; height: 75vh; }
        .calendar-container { flex-basis: 60%; background-color: var(--surface-color); border-radius: var(--border-radius); padding: 2rem; }
        .details-panel { flex-basis: 40%; background-color: var(--surface-color); border-radius: var(--border-radius); padding: 2rem; display: flex; flex-direction: column; }
        #details-content { flex-grow: 1; overflow-y: auto; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .calendar-header h3 { font-size: 1.8rem; margin: 0; }
        .calendar-header button { /* ...省略與顧客端月曆按鈕相同樣式... */ }
        .calendar-weekdays, .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative; }
        .calendar-day.not-current-month { color: #555; background-color: transparent; cursor: default; }
        .calendar-day:not(.not-current-month):hover { background-color: #444; }
        .calendar-day.selected { background-color: var(--primary-color); color: #111; font-weight: bold; }
        .has-menu-dot { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 8px; height: 8px; background-color: var(--primary-color); border-radius: 50%; }
        textarea.menu-input { width: 100%; height: 150px; background-color: #333; border: 1px solid #555; color: var(--text-color); padding: 0.8rem; border-radius: 5px; resize: vertical; margin-top: 1rem; }
        input.vendor-input { width: 100%; padding: 0.8rem; background-color: #333; border: 1px solid #555; color: var(--text-color); border-radius: 5px; }
        .details-section h3 { border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; }
        button.save-btn { width: 100%; padding: 0.8rem; border: none; border-radius: 8px; background: var(--primary-color); color: #111; font-size: 1rem; cursor: pointer; margin-top: 1rem; }
        #order-list { list-style: none; padding: 0; }
        #order-list li { background: rgba(0,0,0,0.2); padding: 0.8rem; border-radius: 5px; margin-bottom: 0.5rem; }
        #order-list .order-user { font-weight: bold; color: var(--primary-color); }
        #order-list .order-text { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>

    <div class="admin-dashboard">
        <header class="tabs">
            <button class="tab-btn active" data-target="tab-menu-management">菜單與訂單管理</button>
            <button class="tab-btn" data-target="tab-chat-management">客服管理</button>
        </header>

        <!-- Tab 1: 菜單與訂單管理 -->
        <div id="tab-menu-management" class="tab-content active">
            <div class="calendar-management-panel">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button id="cal-prev-month-btn"><</button>
                        <h3 id="cal-current-month-year"></h3>
                        <button id="cal-next-month-btn">></button>
                    </div>
                    <div class="calendar-weekdays"><div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div></div>
                    <div class="calendar-grid" id="calendar-grid"></div>
                </div>
                <div class="details-panel">
                    <h2 id="details-date">請選擇日期</h2>
                    <div id="details-content">
                        <!-- 這裡是動態內容區域 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: 客服管理 -->
        <div id="tab-chat-management" class="tab-content">
            <div class="admin-panel">
                <aside class="sidebar">
                    <header class="sidebar-header"><h2>顧客對話列表</h2></header>
                    <ul id="user-list"></ul>
                </aside>
                <main class="chat-view">
                    <header class="chat-header"><h2 id="chat-header-title">選擇一個對話</h2></header>
                    <div id="chat-window"><p id="chat-placeholder">請從左側選擇一位顧客以查看對話紀錄。</p></div>
                </main>
            </div>
        </div>
    </div>

    <script>
        // 設定 API 的基礎 URL
        const API_BASE_URL = 'https://no-one-help-official-website-v3-1.onrender.com';

        // ========== 通用：分頁切換邏輯 ==========
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                tabContents.forEach(c => c.classList.remove('active'));
                document.getElementById(btn.dataset.target).classList.add('active');
            });
        });

        // ========== 月曆管理邏輯 (Calendar Management Logic) ==========
        const calGridEl = document.getElementById('calendar-grid');
        const calMonthYearEl = document.getElementById('cal-current-month-year');
        const calPrevBtn = document.getElementById('cal-prev-month-btn');
        const calNextBtn = document.getElementById('cal-next-month-btn');
        const detailsDateEl = document.getElementById('details-date');
        const detailsContentEl = document.getElementById('details-content');

        let calCurrentDate = new Date();
        let datesWithMenu = [];

        async function fetchMenusForMonth() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/calendar/menus`);
                datesWithMenu = await response.json();
                renderCalendar();
            } catch (error) { console.error('無法獲取菜單日期:', error); }
        }

        function renderCalendar() {
            const year = calCurrentDate.getFullYear();
            const month = calCurrentDate.getMonth();
            calMonthYearEl.textContent = `${year}年 ${month + 1}月`;
            calGridEl.innerHTML = '';
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDayOfMonth; i++) calGridEl.innerHTML += '<div class="calendar-day not-current-month"></div>';

            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = i;
                dayEl.dataset.date = dateStr;

                if (datesWithMenu.includes(dateStr)) {
                    dayEl.innerHTML += '<span class="has-menu-dot"></span>';
                }

                dayEl.addEventListener('click', () => {
                    document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                    dayEl.classList.add('selected');
                    loadDetailsForDate(dateStr);
                });
                calGridEl.appendChild(dayEl);
            }
        }
        
        async function loadDetailsForDate(dateStr) {
            detailsDateEl.textContent = dateStr;
            detailsContentEl.innerHTML = '<p>載入中...</p>';

            // 平行發送兩個請求，獲取菜單和訂單
            const [menuRes, ordersRes] = await Promise.all([
                fetch(`${API_BASE_URL}/api/calendar/menu/${dateStr}`),
                fetch(`${API_BASE_URL}/api/admin/orders/${dateStr}`)
            ]);
            
            let menuData = { menuText: '', vendor: '' };
            if (menuRes.ok) menuData = await menuRes.json();
            const ordersData = ordersRes.ok ? await ordersRes.json() : [];

            // 渲染介面
            detailsContentEl.innerHTML = `
                <div class="details-section">
                    <h3>編輯當日菜單</h3>
                    <label for="vendor-input">店家名稱</label>
                    <input type="text" id="vendor-input" class="vendor-input" value="${menuData.vendor || ''}">
                    <label for="menu-input" style="display: block; margin-top: 1rem;">菜單內容 (文字或連結)</label>
                    <textarea id="menu-input" class="menu-input">${menuData.menuText || ''}</textarea>
                    <button class="save-btn" onclick="saveMenu('${dateStr}')">儲存菜單</button>
                </div>
                <div class="details-section" style="margin-top: 2rem;">
                    <h3>當日訂單 (${ordersData.length} 筆)</h3>
                    <ul id="order-list">
                        ${ordersData.length > 0 ? ordersData.map(order => `
                            <li>
                                <p class="order-user">${order.username}:</p>
                                <p class="order-text">${order.orderText}</p>
                            </li>
                        `).join('') : '<li>尚無訂單</li>'}
                    </ul>
                </div>
            `;
        }

        async function saveMenu(dateStr) {
            const menuText = document.getElementById('menu-input').value;
            const vendor = document.getElementById('vendor-input').value;
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/menu/${dateStr}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ menuText, vendor })
                });
                if(response.ok) {
                    alert('菜單儲存成功！');
                    fetchMenusForMonth(); // 重新獲取菜單資料以更新小圓點
                } else { throw new Error('儲存失敗'); }
            } catch (error) { alert('儲存菜單時發生錯誤。'); }
        }

        calPrevBtn.addEventListener('click', () => { calCurrentDate.setMonth(calCurrentDate.getMonth() - 1); fetchMenusForMonth(); });
        calNextBtn.addEventListener('click', () => { calCurrentDate.setMonth(calCurrentDate.getMonth() + 1); fetchMenusForMonth(); });

        // ========== 客服管理邏輯 (Chat Management Logic - from v4) ==========
        // (此處複製貼上我們之前修正好的 staff.html v4 的客服 JS 邏輯)
        const userListEl = document.getElementById('user-list');
        const chatHeaderTitleEl = document.getElementById('chat-header-title');
        const chatWindowEl = document.getElementById('chat-window');
        let allConversationsData = [];
        let currentSelectedUserId = null;
        let chatFetchInterval;

        function renderUserList() { /* ... 與 staff v4 相同 ... */ }
        function renderChatWindow() { /* ... 與 staff v4 相同 ... */ }
        async function sendReply(userId, messageId) { /* ... 與 staff v4 相同 ... */ }
        async function fetchAllConversations() { /* ... 與 staff v4 相同 ... */ }
        
        // (貼上詳細邏輯)
        function renderUserList() {
            const currentActiveId = userListEl.querySelector('.active')?.dataset.userId;
            userListEl.innerHTML = '';
            if (allConversationsData.length === 0) { userListEl.innerHTML = '<li class="user-item">尚無任何對話</li>'; return; }
            allConversationsData.forEach(convo => {
                const li = document.createElement('li');
                li.className = 'user-item';
                li.textContent = convo.username;
                li.dataset.userId = convo.userId;
                if (convo.userId === currentActiveId) li.classList.add('active');
                li.addEventListener('click', () => {
                    if (currentSelectedUserId !== convo.userId) {
                        currentSelectedUserId = convo.userId;
                        document.querySelectorAll('.user-item').forEach(item => item.classList.remove('active'));
                        li.classList.add('active');
                        renderChatWindow();
                    }
                });
                userListEl.appendChild(li);
            });
        }
        function renderChatWindow() {
            if (!currentSelectedUserId) {
                chatHeaderTitleEl.textContent = '選擇一個對話';
                chatWindowEl.innerHTML = '<p id="chat-placeholder">請從左側選擇一位顧客以查看對話紀錄。</p>';
                return;
            }
            const conversation = allConversationsData.find(c => c.userId === currentSelectedUserId);
            if (!conversation) {
                chatHeaderTitleEl.textContent = '用戶不存在';
                chatWindowEl.innerHTML = '<p id="chat-placeholder">該用戶對話已不存在。</p>';
                return;
            }
            chatWindowEl.innerHTML = ''; 
            chatHeaderTitleEl.textContent = `與 ${conversation.username} 的對話`;
            if (conversation.messages.length === 0) {
                chatWindowEl.innerHTML = '<p id="chat-placeholder">此用戶尚未發送任何訊息。</p>';
                return;
            }
            conversation.messages.forEach(msg => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'message-group';
                let answerHTML = msg.staffReply ? `<p><b>您的回覆:</b> ${msg.staffReply}</p>` : `<p><b>您的回覆:</b> <i>尚未回覆</i></p><div class="reply-area"><input type="text" id="reply-input-${msg.id}" placeholder="請在此輸入回覆..."><button onclick="sendReply('${currentSelectedUserId}', ${msg.id})">送出</button></div>`;
                groupDiv.innerHTML = `<div class="customer-question"><p><b>顧客 (ID: ${msg.id}):</b> ${msg.customerMessage}</p></div><div class="staff-answer">${answerHTML}</div>`;
                chatWindowEl.appendChild(groupDiv);
            });
            chatWindowEl.scrollTop = chatWindowEl.scrollHeight;
        }
        async function sendReply(userId, messageId) {
            const inputEl = document.getElementById(`reply-input-${messageId}`);
            if (!inputEl) return;
            const replyText = inputEl.value.trim();
            if (!replyText) { return alert('回覆內容不能為空！'); }
            try {
                clearInterval(chatFetchInterval);
                const response = await fetch(`${API_BASE_URL}/api/admin/reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, messageId, replyText })
                });
                if (!response.ok) throw new Error('回覆失敗');
                await fetchAllConversations();
            } catch (error) {
                console.error('回覆請求失敗:', error);
                alert('網路錯誤，回覆失敗。');
            } finally {
                startChatFetching();
            }
        }
        async function fetchAllConversations() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/conversations`);
                const latestData = await response.json();
                if (JSON.stringify(latestData) !== JSON.stringify(allConversationsData)) {
                    allConversationsData = latestData;
                    renderUserList();
                    if (currentSelectedUserId) renderChatWindow();
                }
            } catch (error) {
                console.error('獲取所有對話失敗:', error);
                clearInterval(chatFetchInterval);
                userListEl.innerHTML = `<li class="user-item" style="color: red;">無法連接伺服器</li>`;
            }
        }
        
        function startChatFetching() {
             fetchAllConversations();
             if (chatFetchInterval) clearInterval(chatFetchInterval);
             chatFetchInterval = setInterval(fetchAllConversations, 5000);
        }

        // --- 初始化應用 ---
        function init() {
            fetchMenusForMonth(); // 初始化月曆
            startChatFetching();  // 初始化客服系統
        }

        init();
    </script>
</body>
</html>